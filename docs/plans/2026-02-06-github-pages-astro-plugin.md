# Plugin Spec: github-pages-astro

**Date:** 2026-02-06
**Status:** Draft
**Plugin location:** `plugins/github-pages-astro/`

## Problem

The dot-skills repo has an Astro + Starlight documentation site (`site/`) deployed to GitHub Pages. Today, keeping docs in sync with code is entirely manual — Claude has no awareness of the doc site's structure, conventions, or build process. Docs drift out of date as plugins evolve, new features go undocumented, and build errors go unnoticed until CI fails.

## Goal

A Claude Code plugin that gives Claude full knowledge of the doc site and the tools to maintain it: add pages, update content, validate builds, and keep documentation in sync with the codebase.

## Existing Infrastructure

Before designing the plugin, here's what already exists:

| Asset | Location | Notes |
|-------|----------|-------|
| Astro + Starlight site | `site/` | Scaffolded with content, sidebar config, and base/site URLs |
| Content pages | `site/src/content/docs/` | 9 pages across 3 sections (getting-started, guides, reference) |
| Astro config | `site/astro.config.mjs` | Sidebar structure, site URL, social links |
| GitHub Actions (deploy) | `.github/workflows/deploy-docs.yml` | Deploys on push to `main` when `site/**` or `docs/**` change |
| GitHub Actions (PR check) | `.github/workflows/docs-pr-check.yml` | Build check on PRs touching `site/**` or `docs/**` |
| Design docs | `docs/plans/` | Existing design documents (potential doc source material) |
| API reference | `docs/api-reference.md` | Standalone API docs (already mirrored into the site) |

## Plugin Structure

```
plugins/github-pages-astro/
├── .claude-plugin/
│   └── plugin.json
├── commands/
│   ├── docs-dev.md          # Start Astro dev server
│   ├── docs-build.md        # Build site and report errors
│   └── docs-sync.md         # Check docs freshness against codebase
├── skills/
│   └── docs-site/
│       └── SKILL.md          # Site structure, conventions, content authoring
├── hooks/
│   ├── hooks.json
│   ├── docs-freshness-check.sh   # Stop hook: remind about doc updates
│   └── stop-dev-server.sh        # SessionEnd hook: kill astro dev
└── scripts/
    ├── freshness-check.ts    # Compare code state to doc state
    └── link-validator.ts     # Validate internal links
```

---

## Components

### 1. Skill: `docs-site`

**File:** `skills/docs-site/SKILL.md`

Teaches Claude everything it needs to author and maintain the doc site. Active whenever Claude works on documentation or modifies code that has corresponding docs.

**Content the skill should cover:**

#### Site architecture
- Astro + Starlight framework, content lives in `site/src/content/docs/`
- Content collection defined in `site/src/content.config.ts` (standard Starlight `docsLoader`)
- No custom components yet — just Starlight built-ins (`Card`, `CardGrid`, `LinkCard`)
- Build: `npm ci && npx astro build` from `site/`
- Dev server: `npx astro dev` from `site/`
- Base path: `/dot-skills/` (all absolute links must include this prefix)

#### Content conventions
- Pages are `.md` or `.mdx` files under `site/src/content/docs/`
- Required frontmatter: `title`, `description`
- Optional Starlight frontmatter: `sidebar.order`, `sidebar.badge`, `tableOfContents`, `template`
- The landing page (`index.mdx`) uses `template: splash` and imports Starlight components
- All other pages use the default `doc` template (no explicit `template` field needed)

#### Sidebar management
- Sidebar is defined manually in `site/astro.config.mjs` (not autogenerated)
- Every new content page MUST have a corresponding entry in the sidebar config
- Sidebar structure mirrors the content directory: `getting-started/`, `guides/`, `reference/`
- Sidebar entries use `slug` (not `link`) pointing to the content path without file extension

#### Section purposes
| Section | Path | What belongs here |
|---------|------|-------------------|
| Getting Started | `getting-started/` | Overview, installation, quickstart — entry points for new users |
| Guides | `guides/` | Task-oriented walkthroughs (using the kanban board, workstreams, API) |
| Reference | `reference/` | Exhaustive technical details (plugin structure, ticket format, design docs) |

#### Writing style
- Use second person ("you") for guides, third person for reference docs
- Keep pages focused — one concept per page
- Use tables for structured data (frontmatter fields, API endpoints, etc.)
- Use code blocks with language tags for examples
- Internal links use the full path with base prefix: `/dot-skills/guides/kanban-board/`
- No trailing slashes in source-level links (Astro handles this)

#### Relationship to source-of-truth files
- `CLAUDE.md` is the canonical source for project conventions — reference pages should reflect it
- `docs/api-reference.md` is the canonical API reference — `guides/api-reference.md` should mirror it
- SKILL.md files in `plugins/kanban-skill/skills/` are canonical for board conventions and ticket picking — guides and reference pages should stay consistent
- Design docs in `docs/plans/` can be summarized or linked from `reference/design-docs.md`

### 2. Command: `docs-dev`

**File:** `commands/docs-dev.md`

```yaml
---
name: docs-dev
description: Start the documentation site dev server for live preview
allowed-tools: [Bash]
---
```

**Behavior:**
1. Check that Node.js is installed
2. Run `npm ci` in `site/` if `node_modules/` doesn't exist
3. Start `npx astro dev` in the background from `site/`
4. Save PID to `site/.astro-dev.pid`
5. Report the local URL (`http://localhost:4321/dot-skills/`)
6. Inform the user the server will auto-stop when the session ends

### 3. Command: `docs-build`

**File:** `commands/docs-build.md`

```yaml
---
name: docs-build
description: Build the documentation site and report any errors
allowed-tools: [Bash]
---
```

**Behavior:**
1. Run `npm ci` in `site/` if needed
2. Run `npx astro build` in `site/`
3. If build succeeds: report success and the output path (`site/dist/`)
4. If build fails: display the full error output and suggest fixes
5. Optionally run link validation (see scripts section)

### 4. Command: `docs-sync`

**File:** `commands/docs-sync.md`

```yaml
---
name: docs-sync
description: Check documentation freshness against the codebase
allowed-tools: [Bash, Read, Glob, Grep]
---
```

**Behavior:**

This is the most interesting command. It performs a freshness audit:

1. **Sidebar completeness** — Verify every `.md`/`.mdx` file in `site/src/content/docs/` has a sidebar entry in `astro.config.mjs`, and vice versa
2. **API reference drift** — Compare `docs/api-reference.md` (canonical) with `site/src/content/docs/guides/api-reference.md` to detect divergence
3. **Plugin structure drift** — Compare actual plugin directory layout against what `reference/plugin-structure.md` documents
4. **CLAUDE.md drift** — Check if `CLAUDE.md` conventions match what the overview and reference pages describe
5. **Missing docs for new plugins** — If `plugins/` contains directories not covered in the docs, flag them

Output: A report listing stale/missing/diverged docs with suggested actions.

### 5. Hook: `docs-freshness-check` (Stop)

**File:** `hooks/docs-freshness-check.sh`

**Trigger:** Stop (runs when Claude tries to end a turn)

**Logic:**
1. Check `git diff --name-only HEAD` for files modified in this session
2. If modifications touch `plugins/`, `CLAUDE.md`, or `docs/api-reference.md`:
   - Check whether corresponding doc pages in `site/src/content/docs/` were also modified
   - If not: exit code 2 with a message reminding Claude to update docs
3. If no relevant source files changed, or if docs were also updated: exit 0

This is a soft enforcement — it flags when code changes likely need doc updates but doesn't block on every change. The heuristic:

| Source change | Expected doc update |
|---------------|-------------------|
| `plugins/kanban-skill/server/api.ts` | `guides/api-reference.md` |
| `plugins/kanban-skill/skills/*/SKILL.md` | `guides/kanban-board.md` or `guides/workstreams.md` |
| `plugins/kanban-skill/commands/*.md` | `reference/plugin-structure.md` |
| `plugins/kanban-skill/hooks/*` | `reference/plugin-structure.md` |
| `CLAUDE.md` | `getting-started/overview.md`, `reference/*` |
| New plugin directory | Flag as needing new doc pages |

**Important design decision:** This hook should be conservative. It should only fire when there's a clear signal that docs are stale — not on every code change. False positives train users to ignore the hook.

### 6. Hook: `stop-dev-server` (SessionEnd)

**File:** `hooks/stop-dev-server.sh`

**Trigger:** SessionEnd

**Logic:**
1. Check for `site/.astro-dev.pid`
2. If found, read PID and kill the process
3. Fallback: `pkill -f "astro dev"` scoped to the site directory
4. Remove PID file

Mirrors the pattern from kanban-skill's `stop-server-on-exit.sh`.

### 7. Scripts

Utility scripts that commands invoke. These live in `scripts/` rather than `hooks/` because they're tools, not lifecycle hooks.

#### `freshness-check.ts`

A Bun script that implements the freshness audit logic for `docs-sync`. Extractable into a script so both the command and the hook can share logic.

**Inputs:** Project root path
**Output:** JSON report of stale/missing/diverged items

```typescript
interface FreshnessReport {
  sidebarOrphans: string[];      // sidebar entries with no matching file
  undocumentedPages: string[];   // content files with no sidebar entry
  stalePages: StaleItem[];       // pages that may be out of date
  missingPluginDocs: string[];   // plugin dirs with no doc coverage
}

interface StaleItem {
  docPage: string;
  sourceFile: string;
  reason: string;  // e.g., "source modified more recently than doc"
}
```

#### `link-validator.ts`

A Bun script that crawls the built site output (`site/dist/`) and validates:
- All internal links resolve to existing pages
- Anchor links (`#section`) point to existing headings
- No broken image references

**Inputs:** Path to `site/dist/`
**Output:** List of broken links with source page and target

---

## Marketplace Registration

Add the new plugin to `.claude-plugin/marketplace.json`:

```json
{
  "plugins": [
    { "name": "kanban-skill", ... },
    {
      "name": "github-pages-astro",
      "source": "./plugins/github-pages-astro",
      "description": "Documentation site management for Astro + Starlight on GitHub Pages",
      "version": "1.0.0",
      "author": { "name": "David Kormushoff" }
    }
  ]
}
```

## Plugin Registration

**File:** `plugins/github-pages-astro/.claude-plugin/plugin.json`

```json
{
  "name": "github-pages-astro",
  "description": "Documentation site management for Astro + Starlight on GitHub Pages",
  "version": "1.0.0",
  "author": { "name": "David Kormushoff" },
  "hooks": "./hooks/hooks.json"
}
```

---

## Design Decisions & Open Questions

### Decisions made

1. **Separate plugin, not part of kanban-skill.** The doc site is a distinct concern. Keeping it as its own plugin means it can be enabled/disabled independently and reused in other repos with Astro + Starlight sites.

2. **Soft doc-freshness enforcement via Stop hook.** The hook reminds but doesn't hard-block. Hard-blocking would be too aggressive — not every code change needs a doc update, and the heuristic can't be perfect.

3. **Sidebar is manually managed, not autogenerated.** Starlight supports autogenerated sidebar from directory structure, but manual control gives better labeling and ordering. The plugin should validate that sidebar entries and files stay in sync rather than trying to autogenerate.

4. **Freshness check as both command and hook.** The `/docs-sync` command gives a full audit on demand. The Stop hook does a lightweight version (just checks git diff overlap). They share logic via `scripts/freshness-check.ts`.

5. **Scripts use Bun + TypeScript.** Consistent with the kanban-skill server. Bun is already a project dependency.

### Open questions

1. **Should the skill cover Astro/Starlight generically or be specific to this repo?** Current spec is repo-specific (documents this site's sections, conventions, base path). A more generic version could teach Claude Astro/Starlight in general and be parameterized per-repo. Starting repo-specific is simpler; can generalize later if reuse demand emerges.

2. **Should `docs-sync` auto-fix or just report?** Current spec is report-only. Auto-fix (e.g., copying `docs/api-reference.md` into the site content) is tempting but risky — the site version may have Starlight-specific formatting that a raw copy would break. Recommend: report only, let Claude decide how to fix.

3. **Should the plugin manage the GitHub Actions workflows?** The deploy and PR-check workflows already exist. The plugin could validate that they're configured correctly (e.g., right paths, right Node version). For now, leave them outside the plugin's scope — they're stable infrastructure.

4. **How should the freshness check handle new plugins?** When a new plugin is added to `plugins/`, the check should flag that no doc pages exist for it. But should it also generate a doc stub? Leaning toward just flagging — stub generation is better handled by Claude in context.

5. **Should `/docs-dev` open the browser automatically?** The kanban `/serve` command does. Whether this is desirable depends on the environment (works in desktop Claude Code, not in headless/SSH sessions). Could gate on `DISPLAY` or `BROWSER` env var.

---

## Implementation Order

Recommended build sequence:

1. **Plugin scaffold** — Create directory structure, `plugin.json`, empty `hooks.json`
2. **Skill: `docs-site`** — Write the SKILL.md with full site knowledge (highest value, no dependencies)
3. **Command: `docs-dev`** — Dev server command + SessionEnd hook to clean up
4. **Command: `docs-build`** — Build command (straightforward)
5. **Command: `docs-sync`** — Freshness audit (most complex, depends on `freshness-check.ts`)
6. **Script: `freshness-check.ts`** — Shared freshness logic
7. **Hook: `docs-freshness-check`** — Stop hook using freshness logic
8. **Script: `link-validator.ts`** — Post-build link validation
9. **Marketplace registration** — Add to `marketplace.json`
10. **Update existing docs** — Add a page about this plugin to the doc site itself

---

## Component Interaction Diagram

```
┌─────────────────────────────────────────────────────────┐
│                   Claude Code Session                    │
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌───────────────┐  │
│  │   Commands   │  │    Skill     │  │     Hooks     │  │
│  │              │  │              │  │               │  │
│  │ /docs-dev    │  │ docs-site:   │  │ Stop: check   │  │
│  │ starts dev   │  │ teaches site │  │ doc freshness │  │
│  │ server       │  │ structure,   │  │ when code     │  │
│  │              │  │ conventions, │  │ changes       │  │
│  │ /docs-build  │  │ authoring    │  │               │  │
│  │ builds site  │  │ rules        │  │ SessionEnd:   │  │
│  │              │  │              │  │ stop dev      │  │
│  │ /docs-sync   │  │              │  │ server        │  │
│  │ audits       │  │              │  │               │  │
│  │ freshness    │  │              │  │               │  │
│  └──────┬───────┘  └──────────────┘  └───────┬───────┘  │
│         │                                     │          │
└─────────┼─────────────────────────────────────┼──────────┘
          │                                     │
          ▼                                     ▼
   ┌─────────────┐                    ┌──────────────────┐
   │   site/     │                    │   plugins/       │
   │  (Astro +   │                    │   (source of     │
   │  Starlight) │                    │    truth for     │
   │             │                    │    doc content)  │
   └─────────────┘                    └──────────────────┘
          │
          ▼
   ┌─────────────┐
   │  GitHub     │
   │  Pages      │
   │  (deployed  │
   │  via CI)    │
   └─────────────┘
```
